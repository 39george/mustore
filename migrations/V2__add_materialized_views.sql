CREATE MATERIALIZED VIEW available_songs AS (
    SELECT
        s.id AS song_id,
        p.name AS name,
        u.username AS author,
        s.tempo,
        s.key,
        s.sex,
        pg.name AS primary_genre,
        sg.name AS secondary_genre,
        p.created_at AS created_at,
        p.description,
        p.price,
        o.key AS cover_url,
        COUNT(DISTINCT l.id) AS likes, -- Make sure to count distinct records
        COUNT(DISTINCT list.id) AS listenings, -- Same for listenings
        ARRAY_AGG(DISTINCT m.name) FILTER (WHERE pt.products_id = p.id) AS vibes,
        (
            COUNT(DISTINCT l.id) * 1.0 + 
            COUNT(DISTINCT list.id) * 0.5 +
            GREATEST(100 - EXTRACT(DAY FROM CURRENT_DATE - p.created_at), 0) * 1.0
        ) AS relevance_score
    FROM songs s
    JOIN products p ON s.products_id = p.id
    JOIN genres pg ON s.primary_genre = pg.id
    JOIN users u ON p.owner_id = u.id
    LEFT JOIN genres sg ON s.secondary_genre = sg.id
    LEFT JOIN objects o ON o.cover_products_id = s.id
    LEFT JOIN likes l ON l.songs_id = s.id
    LEFT JOIN listenings list ON list.songs_id = s.id
    JOIN products_moods pt ON pt.products_id = p.id
    JOIN moods m ON pt.moods_id = m.id
    WHERE p.status = 'active'
    GROUP BY s.id, u.id, pg.name, sg.name, p.id, o.key
);

INSERT INTO genres (name)
VALUES 
('Абстрактный'),
('Акапелла'),
('Эсид'),
('Эсид джаз'),
('Эсид панк'),
('Эсид рэп'),
('Акустический'),
('Афробит'),
('Альтернатива'),
('Альтернативный рок'),
('Эмбиент'),
('Аниме'),
('Авангард'),
('Баллада'),
('Бас'),
('Биты с хуками'),
('Бибоп'),
('Биг-бенд'),
('Блэк-метал'),
('Блюграсс'),
('Блюз'),
('Бритпоп'),
('Кабаре'),
('Кельтская музыка'),
('Камерная музыка'),
('Шансон'),
('Хор'),
('Христианская музыка'),
('Христианский рок'),
('Кинематографическая'),
('Классический рок'),
('Классик'),
('Клубная'),
('Клубный хаус'),
('Комедия'),
('Сознательная музыка'),
('Современная христианская музыка'),
('Кантри'),
('Кантри-рэп'),
('Кранк'),
('Культовая музыка'),
('Танцевальная'),
('Дэнсхолл'),
('Дарквейв'),
('Дэт-метал'),
('Диско'),
('Дрим'),
('Дрилл'),
('Драм-н-бэйс'),
('Соло на барабанах'),
('Дабстеп'),
('Дуэт'),
('Легкая музыка'),
('Электро'),
('Этническая музыка'),
('Евро-хаус'),
('Евро-техно'),
('Евродэнс'),
('Экспериментальная'),
('Фолк'),
('Фолк-рок'),
('Фольклор'),
('Фристайл'),
('Фанк'),
('Фьюжн'),
('Футуристическая'),
('Джи-фанк'),
('Музыка из игр'),
('Гангста-рэп'),
('Гетто хаус'),
('Госпел'),
('Готика'),
('Готический рок'),
('Грайм'),
('Гранж'),
('Хард-рок'),
('Хардкор'),
('Хэви-метал'),
('Хип-хоп'),
('Хорроркор'),
('Хаус'),
('Инди'),
('Индастриал'),
('Инструментальная'),
('Инструментальный поп'),
('Инструментальный рок'),
('Джаз'),
('Джаз/фанк'),
('Джей-поп'),
('Джангл'),
('Латина'),
('Лоу-фай'),
('Медитативная'),
('Метал'),
('Мюзикл'),
('Национальный фолк'),
('Нью Эйдж'),
('Нью Скул'),
('Нью вейв'),
('Олд Скул'),
('Опера'),
('Оркестровая музыка'),
('Прочее'),
('Поп'),
('Поп-фолк'),
('Поп/Фанк'),
('Прогрессивный рок'),
('Психоделика'),
('Психоделический рок'),
('Панк'),
('Панк-рок'),
('RnB'),
('Рэп'),
('Рейв'),
('Регги'),
('Реггетон'),
('Ретро'),
('Ритмический соул'),
('Рок'),
('Рок-н-ролл'),
('Сальса'),
('Самба'),
('Ска'),
('Слоу джэм'),
('Слоу рок'),
('Соната'),
('Соул'),
('Саундтрек'),
('Космическая музыка'),
('Речь'),
('Свинг'),
('Симфонический рок'),
('Симфония'),
('Синтпоп'),
('Танго'),
('Техно'),
('Техно-индастриал'),
('Транс'),
('Трэп'),
('Трэш метал'),
('Трип-хоп'),
('Андерграунд'),
('Вокал'),
('Мировая музыка'),
('Зук');

INSERT INTO moods (name)
VALUES 
('агрессивный'),
('амбиент'),
('сердитый'),
('подвижный'),
('успокаивающий'),
('беззаботный'),
('веселый'),
('холодный'),
('сложный'),
('крутой'),
('темный'),
('тревожный'),
('драматичный'),
('мечтательный'),
('жуткий'),
('изысканный'),
('энергичный'),
('восторженный'),
('эпический'),
('фанковый'),
('футуристичный'),
('нежный'),
('в восторге'),
('мрачный'),
('грувовый'),
('счастливый'),
('резкий'),
('завораживающий'),
('юмористический'),
('гипнотический'),
('индустриальный'),
('интенсивный'),
('интимный'),
('радостный'),
('расслабленный'),
('легкий'),
('живой'),
('безумный'),
('мягкий'),
('мистический'),
('зловещий'),
('страстный'),
('пасторальный'),
('мирный'),
('игривый'),
('трогательный'),
('тихий'),
('мятежный'),
('задумчивый'),
('романтический'),
('шумный'),
('грустный'),
('сентиментальный'),
('сексуальный'),
('гладкий'),
('космический'),
('духовный'),
('странный'),
('сладкий'),
('театральный'),
('триповый'),
('теплый'),
('капризный');
